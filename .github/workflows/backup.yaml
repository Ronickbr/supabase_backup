name: supabase-backup

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * 0" # Executa todo domingo à meia-noite

env:
  BACKUP_ENABLED: true

jobs:
  run_db_backup:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    # Se BACKUP_ENABLED for falso no nível do job, ele nem inicia
    if: vars.BACKUP_ENABLED == 'true' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Baixa o histórico completo para evitar erros de push

      - name: Set current date
        id: date
        run: echo "NOW=$(date +'%Y.%m.%d-%H%M')" >> $GITHUB_ENV

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Create backup directory
        run: mkdir -p prisma/backups

      - name: Backup roles
        env:
          SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
        run: supabase db dump --db-url "$SUPABASE_DB_URL" -f prisma/backups/roles.sql --role-only

      - name: Backup schema
        env:
          SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
        run: supabase db dump --db-url "$SUPABASE_DB_URL" -f prisma/backups/schema.sql

      - name: Backup data
        env:
          SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
        run: supabase db dump --db-url "$SUPABASE_DB_URL" -f prisma/backups/data.sql --data-only --use-copy

      - name: Commit and Tag Backup
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Database Backup [${{ env.NOW }}]"
          file_pattern: 'prisma/backups/*.sql'
          commit_user_name: github-actions[bot]
          commit_user_email: github-actions[bot]@users.noreply.github.com
          # Cria uma tag de versão para cada backup
          tagging_message: "v${{ env.NOW }}"
          # Força o push para evitar erros de histórico divergente
          push_options: '--force'
